pipeline {
agent {label 'merlin'}
    stages {
        stage ("build-aws-blaze") {
            steps {
                 dir("ws-blaze") {
		 checkout scm
                 script {
                        sh "rm -rf release"
                        sh "mkdir release"
                        dir("release"){
				sh "cd ~/Code-latest/genome-release; git pull"
                            sh "cp ~/Code-latest/genome-release/build/common/tools/bin/sdaccel.ini /curr/limark/falcon2/blaze/bin"
                            sh "source /curr/software/util/modules-tcl/init/bash"
                            sh "module load sdx/17.4; cmake -DCMAKE_BUILD_TYPE=Release -DRELEASE_VERSION=aws -DDEPLOYMENT_DST=aws -DCMAKE_INSTALL_PREFIX=/curr/limark/falcon2/blaze .. "
                            sh "make -j 8"
                            sh "make install"
                            sh "make test"
                            }
                        }
                    }
                }
            }
          stage ("build-hwc-blaze") {
                steps {
                     dir("ws-blaze") {
                     script {
                            sh "rm -rf release"
                            sh "mkdir release"
                            dir("release"){
                                sh "cp ~/Code-latest/genome-release/build/common/tools/bin/sdaccel.ini /curr/limark/falcon-hwc/blaze/bin"
                                sh "source /curr/software/util/modules-tcl/init/bash"
                                sh "module load sdx/17.4; cmake -DCMAKE_BUILD_TYPE=Release -DRELEASE_VERSION=hwc -DDEPLOYMENT_DST=hwc -DCMAKE_INSTALL_PREFIX=/curr/limark/falcon-hwc/blaze .. "
                                sh "make -j 8"
                                sh "make install"
                                sh "make test"
                                }
                            }
                        }
                    }
                }
                stage ("build-local-blaze") {
                    steps {
                         dir("ws-blaze") {
                         script {
                                sh "rm -rf release"
                                sh "mkdir release"
                                dir("release"){
                                    sh "cp ~/Code-latest/genome-release/build/common/tools/bin/sdaccel.ini /curr/limark/falcon-local/blaze/bin"
                                    sh "source /curr/software/util/modules-tcl/init/bash"
                                    sh "module load xrt; cmake -DCMAKE_BUILD_TYPE=Release -DRELEASE_VERSION=Internal on AWS -DDEPLOYMENT_DST=Internal -DCMAKE_INSTALL_PREFIX=/curr/limark/falcon-local/blaze .. "
                                    sh "make -j 8"
                                    sh "make install"
                                    sh "make test"
                                    }
                                }
                            }
                        }
                    }            
        }
    post {
            always {

                emailext attachLog: true, body: "${currentBuild.currentResult}: Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More info at: ${env.BUILD_URL}console",
                    recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']],
                    subject: "Jenkins Build ${currentBuild.currentResult}: Job ${env.JOB_NAME}",
                    to: 'allwu@falcon-computing.com, roshantha@limarktech.com'

        }
    }
}  
